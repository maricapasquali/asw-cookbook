<template>
 <b-container class="file-uploader text-center" fluid>
   <b-modal centered v-model="zoom" hide-footer @hidden="closeZoomImage">
     <b-img fluid center :src="profile_img"></b-img>
   </b-modal>
   <b-row>
     <b-form-file
         :id="id" v-show="false"
         @change="loadImage"
         ref="uploader"
         accept="image/*"
     ></b-form-file>
     <b-img v-if="profile_img"
         id="img-profile"
         :thumbnail="isSetImage"
         width="200"
         height="200"
         rounded="circle"
         fluid
         center
         :src="profile_img"
         @click="openZoomImage"
         @error="imgError"
         alt="Imagine profilo"></b-img>
     <b-icon-person-circle v-else :width="100" :height="100" class="mx-auto"/>
   </b-row>
   <b-row>
    <b-container fluid class="text-center">
      <b-button v-if="isSetImage" @click="cancelImage" variant="secondary">Annulla</b-button>
      <b-button @click="clickLoad" variant="primary">Carica</b-button>
      <b-button v-if="removable" @click="removeImg" variant="primary">Rimuovi</b-button>
    </b-container>
   </b-row>
 </b-container>
</template>

<script>

import {ReaderStreamImage} from "@services/filesystem";

export default {
  name: "image-preview-uploader",
  props: {
    id: String,
    value: File,
    zoomable: {
      type: Boolean,
      default: false
    },
    default: String | File,
    removable: {
      type: Boolean,
      default: false
    }
  },

  data: function (){
    return {
      profile_img: '',
      zoom: false,
      remove: false,
    }
  },
  computed: {
    isSetImage: function (){
      return !this.isDefaultImage
    },
    isDefaultImage: function (){
      return this.profile_img === this.getDefault //(this.default === this.profile_img || this.profile_img === '')
    },
    getDefault(){
      return this.default || ''
    }
  },
  methods:{

    imgError: function (err){
      if(err) console.error(err)
      this.profile_img = this.getDefault
    },
    openZoomImage: function (){
      if(!this.zoomable || this.isDefaultImage) return ;
      console.log('Open Zoom ...')
      this.zoom = true
    },
    closeZoomImage: function (){
      if(!this.zoomable || this.isDefaultImage) return ;
      console.log('Close Zoom ...')
      this.zoom = false
    },
    clickLoad: function (){
      this.$refs.uploader.$el.firstChild.click()
    },
    cancelImage: function (){
      if(this.isDefaultImage) return ;
      this.$refs.uploader.reset()
      this.profile_img = this.getDefault
      this.$emit('selectImage')
    },
    loadImage: function (e){
     this.readFile(e.target.files[0], true)
    },
    readFile: function(files, emit = false){
      if(ReaderStreamImage.isValid(files)){
        if(emit) this.$emit('selectImage', files)
        ReaderStreamImage.read(files,
            function (e){
              console.log('Load image preview...')
              this.profile_img = e.target.result
              // console.debug(this.profile_img)
            }.bind(this),
            this.imgError.bind(this))
      } else this.imgError('File is not image')
    },
    removeImg: function (){
      //TODO: REMOVABLE IMAGE
    }
  },
  created() {
    this.readFile(this.value)
  },
}
</script>

<style scoped>
</style>